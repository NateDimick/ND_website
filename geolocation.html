<!DOCTYPE html>
<html>
    <head>
        <title>Geolocation Test</title>
    </head>
    <body>
        <script>
            function getBrowserLocation (accuracy) {
                let geo = navigator.geolocation;  // geolocation gets more accurate over time once enabled??? so by placing this line ahead of geo.getCurrentPosition buys time (milliseconds) for the browser to be accurate
                return new Promise((resolve, reject) => {
                    function successCallback(position) {
                        let pos = position.coords;
                        if (pos.accuracy < accuracy) {
                            resolve(pos);
                        } else {
                            console.log("bad accuracy", pos.accuracy);
                            resolve(getBrowserLocation(accuracy * 1.5));  // recursive locationing - bad idea or terrible idea???
                        }
                    }
                    function errorCallback(error) {
                        reject(error.message);
                    }
                    const options = {
                        enableHighAccuracy: true // removed timeout and max age because browsers like Edge are SLOW on geoloaction
                    }
                    try {
                        geo.getCurrentPosition(successCallback, errorCallback, options);
                    } catch (error) {
                        reject(error);
                    }
                    
                })
            } 
            async function getLocation() {
                let loc = document.getElementById("location");

                let browserPosition;
                try {
                    browserPosition = await getBrowserLocation(500);
                } catch (error) {
                    browserPosition = "Geolocation either diabled or denied. Please allow geolocation";
                }
                if (typeof browserPosition !== "string") {
                    let req = await fetch(`https://open.mapquestapi.com/geocoding/v1/reverse?key=v4AYOi4EK5CrixkWHmGcPCfeA20X7P8y&location=${browserPosition.latitude},${browserPosition.longitude}`);
                    let res = await req.json();
                    res = res.results[0].locations[0];
                    loc.innerHTML = `lat: ${browserPosition.latitude} <br> long: ${browserPosition.longitude} <br> acc: ${browserPosition.accuracy} meters <br> loc: ${res.street} ${res.adminArea5}, ${res.adminArea3} ${res.postalCode}`;
                } else {
                    loc.innerHTML = browserPosition;
                }
                

                let loc2 = document.getElementById("location2");
                async function ipLocation() {
                    let req = await fetch("https://ipinfo.io/json");
                    let res = await req.json();

                    let req2 = await fetch(`https://open.mapquestapi.com/geocoding/v1/reverse?key=v4AYOi4EK5CrixkWHmGcPCfeA20X7P8y&location=${res.loc}`);
                    let res2 = await req2.json();
                    res2 = res2.results[0].locations[0];
                    loc2.innerHTML =  `lat: ${res.loc.split(",")[0]} <br> long: ${res.loc.split(",")[1]} <br> isp: ${res.org} <br> loc: ${res2.street} ${res2.adminArea5}, ${res2.adminArea3} ${res2.postalCode}`;
                }
                ipLocation();
                document.getElementById("the-button").disabled = true;
                document.getElementById("results").style.display = "block";
            }
        </script>
        <div style="align-content: center;">
            <h1>
                Your location
            </h1>
            <button onclick="getLocation()" id="the-button">Click for Location</button>
            <div id="results" style="display: none;">
                <h2>Result A</h2>
                <input type="radio" name="loc" id="a">
                <label for="a" id="location"></label>
                <br>
                <h2>Result B</h2>
                <input type="radio" name="loc" id="b">
                <label for="b" id="location2"></label>
            </div>
            <h2 id="location"></h2>
            <h2 id="location2"></h2>
        </div>
    </body>
</html>